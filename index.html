<!DOCTYPE html>
<html>
<head>
  <title>Gmail Inbox Viewer Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Identity Services & Gmail API Discovery -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background: #f3f3f3;}
    .container {
      max-width: 380px; margin: 80px auto; padding: 32px 24px 24px 24px;
      background: #fff; border-radius: 10px; box-shadow: 0 2px 16px #bbb;
      min-height: 220px;
    }
    h2 { margin-bottom: 18px; font-size: 22px; color: #333; }
    button {
      margin-top: 22px; padding: 12px 0; width: 100%;
      background: #4285f4; color: #fff; border: none; border-radius: 4px;
      font-size: 16px; cursor: pointer; font-weight: bold;
      transition: background 0.2s;
    }
    button:hover { background: #3367d6; }
    #user-info { margin-top: 32px; color: #333; font-size: 15px; }
    .mail { margin: 8px 0; border-bottom: 1px solid #eee; padding-bottom: 6px;}
    .mail span { display: inline-block; max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Gmail Inbox Viewer</h2>
    <button onclick="handleLogin()">Login with Google</button>
    <div id="user-info"></div>
    <div id="mails"></div>
  </div>
  <script>
    const CLIENT_ID = "618225708417-fdfneali7ds2e2u0oqinnpp8akert50i.apps.googleusercontent.com";
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    function handleLogin() {
      google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if(tokenResponse && tokenResponse.access_token) {
            gapi.load('client', async () => {
              await gapi.client.init({
                apiKey: '', // API key optional for browser, or you can use yours if quota is needed
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
              });
              gapi.client.setToken({ access_token: tokenResponse.access_token });
              displayProfile(tokenResponse.access_token);
              listInbox();
            });
          }
        },
        prompt: 'consent'
      }).requestAccessToken();
    }

    function displayProfile(accessToken) {
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + accessToken }
      })
      .then(res => res.json())
      .then(profile => {
        document.getElementById("user-info").innerHTML =
          `<b>Welcome, ${profile.name}</b><br/>
          <img src="${profile.picture}" width="48" style="border-radius:50%"><br/>
          <span style="color:#444">${profile.email}</span>`;
      });
    }

    async function listInbox() {
      // List the latest 10 inbox messages (can adjust maxResults)
      const res = await gapi.client.gmail.users.messages.list({
        userId: 'me',
        labelIds: ['INBOX'],
        maxResults: 10
      });

      const mailsDiv = document.getElementById("mails");
      mailsDiv.innerHTML = '<h3 style="margin-top:20px;font-size:16px;">Latest Inbox Mails:</h3>';

      if(!res.result.messages || res.result.messages.length == 0) {
        mailsDiv.innerHTML += '<i>No mails found in Inbox.</i>';
        return;
      }

      // Fetch subject/sender for each mail
      const requests = res.result.messages.map(msg =>
        gapi.client.gmail.users.messages.get({userId:'me', id: msg.id, format: 'metadata', metadataHeaders: ['From','Subject']})
      );

      const results = await Promise.all(requests);
      results.forEach(item => {
        const headers = item.result.payload.headers;
        const from = headers.find(h=>h.name=='From')?.value || 'Unknown';
        const subject = headers.find(h=>h.name=='Subject')?.value || '(No Subject)';
        mailsDiv.innerHTML += `<div class="mail"><b>From:</b> <span title="${from}">${from}</span><br><b>Subject:</b> <span title="${subject}">${subject}</span></div>`;
      });
    }
  </script>
</body>
</html>
